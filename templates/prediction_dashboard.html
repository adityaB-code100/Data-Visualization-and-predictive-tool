<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Prediction App</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-500 to-indigo-600 min-h-screen p-5 font-sans">

  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-400 to-cyan-400 text-white text-center py-10">
      <h1 class="text-4xl font-light mb-2">ü§ñ AI Prediction App</h1>
      <p class="text-lg opacity-90">Upload your data, select features, and get instant predictions using machine learning</p>
    </div>

    <div class="p-10 space-y-10">
      
      <!-- Step 1: Upload -->
      <div id="step1" class="border-2 border-gray-200 rounded-lg p-8 bg-gray-50">
        <h3 class="flex items-center text-xl mb-6"><span class="w-8 h-8 flex items-center justify-center bg-blue-400 text-white rounded-full mr-4 font-bold">1</span>Upload Your Data</h3>
        <div id="uploadArea" class="border-4 border-dashed border-gray-300 rounded-lg p-16 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50">
          <div class="text-6xl mb-4">üìä</div>
          <h4 class="text-xl mb-2">Drop your CSV or Excel file here</h4>
          <p class="mb-4">or click to browse files</p>
          <input type="file" id="fileInput" class="hidden" accept=".csv,.xls,.xlsx">
          <button class="bg-gradient-to-r from-blue-400 to-cyan-400 text-white px-8 py-3 rounded-full hover:shadow-lg" onclick="document.getElementById('fileInput').click()">Choose File</button>
        </div>
        <div id="uploadInfo" class="hidden mt-4 p-4 bg-blue-100 text-blue-700 rounded"></div>
        <div id="uploadError" class="hidden mt-4 p-4 bg-red-400 text-white rounded"></div>
      </div>

      <!-- Step 2: Column Selection -->
      <div id="step2" class="hidden border-2 border-gray-200 rounded-lg p-8 bg-gray-50">
        <h3 class="flex items-center text-xl mb-6"><span class="w-8 h-8 flex items-center justify-center bg-blue-400 text-white rounded-full mr-4 font-bold">2</span>Select Target and Features</h3>
        <div class="grid md:grid-cols-2 gap-8">
          <!-- Target -->
          <div class="bg-gray-100 p-6 rounded-lg">
            <h4 class="text-lg mb-4">üéØ Target Column (What to predict)</h4>
            <select id="targetCol" class="w-full p-3 border-2 border-gray-300 rounded">
              <option value="">Select target column...</option>
            </select>
          </div>
          <!-- Features -->
          <div class="bg-gray-100 p-6 rounded-lg">
            <h4 class="text-lg mb-4">üìã Feature Columns (Input features)</h4>
            <div id="featureCols" class="max-h-48 overflow-y-auto border border-gray-300 rounded p-2 space-y-2"></div>
          </div>
        </div>
        <button id="trainBtn" class="mt-6 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-full disabled:bg-gray-400" disabled>üöÄ Train Model</button>
        <div id="trainInfo" class="hidden mt-4 p-4 bg-blue-100 text-blue-700 rounded"></div>
        <div id="trainError" class="hidden mt-4 p-4 bg-red-400 text-white rounded"></div>
      </div>

      <!-- Step 3: Prediction Form -->
      <div id="step3" class="hidden border-2 border-gray-200 rounded-lg p-8 bg-gray-50">
        <h3 class="flex items-center text-xl mb-6"><span class="w-8 h-8 flex items-center justify-center bg-blue-400 text-white rounded-full mr-4 font-bold">3</span>Make Predictions</h3>
        <div id="predictionForm" class="space-y-4"></div>
        <button id="predictBtn" class="mt-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-full">üîÆ Predict</button>
        <div id="result" class="hidden mt-4 p-4 bg-green-400 text-white rounded text-center text-lg font-bold"></div>
        <div id="predictError" class="hidden mt-4 p-4 bg-red-400 text-white rounded"></div>
      </div>

    </div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center p-10">
      <div class="w-10 h-10 border-4 border-gray-300 border-t-blue-400 rounded-full mx-auto animate-spin mb-4"></div>
      <p>Processing...</p>
    </div>

  </div>


    <script>
    let columnInfo = {};
    let selectedFeatures = [];
    
    $(document).ready(function(){
        // File upload handling
        $('#fileInput').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
            }
        });
        
        // Drag and drop functionality
        const uploadArea = $('#uploadArea');
        uploadArea.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });
        
        uploadArea.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });
        
        uploadArea.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        });
        
        // Target column selection
        $('#targetCol').on('change', function() {
            const selectedTarget = $(this).val();
            updateFeatureCheckboxes(selectedTarget);
            updateTrainButton();
        });
        
        // Feature selection
        $(document).on('change', 'input[name="features"]', function() {
            updateTrainButton();
        });
        
        // Train model
        $('#trainBtn').on('click', function() {
            trainModel();
        });
        
        // Make prediction
        $('#predictBtn').on('click', function() {
            makePrediction();
            });
        });

    function showLoading() {
        $('#loading').show();
    }
    
    function hideLoading() {
        $('#loading').hide();
    }
    
    function showError(elementId, message) {
        $(elementId).html(message).removeClass('hidden');
        setTimeout(() => $(elementId).addClass('hidden'), 5000);
    }
    
    function showInfo(elementId, message) {
        $(elementId).html(message).removeClass('hidden');
    }
    
    function hideMessages() {
        $('.error, .info').addClass('hidden');
    }
    
    function uploadFile(file) {
        hideMessages();
        showLoading();
        
        const formData = new FormData();
        formData.append('file', file);
        
            $.ajax({
            url: '/upload_file',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
                hideLoading();
                if (response.error) {
                    showError('#uploadError', response.error);
                } else {
                    columnInfo = response.column_info;
                    populateColumns(response.columns);
                    showInfo('#uploadInfo', response.message);
                    $('#step2').removeClass('hidden').addClass('active');
                    $('#step1').removeClass('active');
                }
            },
            error: function(xhr) {
                hideLoading();
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed';
                showError('#uploadError', error);
            }
        });
    }
    
    function populateColumns(columns) {
        // Populate target column dropdown (only numerical columns, exclude date columns)
        $('#targetCol').empty().append('<option value="">Select target column...</option>');
        columns.forEach(function(col) {
            const info = columnInfo[col];
            if (info.is_numerical && !info.is_date) {
                const option = $(`<option value="${col}">${col} (Numerical)</option>`);
                if (info.null_count > 0) {
                    option.attr('title', `${info.null_count} missing values`);
                }
                $('#targetCol').append(option);
            }
        });
        
        // Populate feature checkboxes (exclude target column and date columns)
        $('#featureCols').empty();
        columns.forEach(function(col) {
            const info = columnInfo[col];
            
            // Skip date columns
            if (info.is_date) {
                return;
            }
            
            const checkboxItem = $(`
                <div class="checkbox-item">
                    <input type="checkbox" name="features" value="${col}" id="feature_${col}">
                    <label for="feature_${col}">${col}</label>
                </div>
            `);
            
            // Add column type indicator
            const typeIndicator = info.is_numerical ? 'üî¢ Numerical' : 'üìù Categorical';
            checkboxItem.append(`<div class="column-info">${typeIndicator}</div>`);
            
            if (info.null_count > 0) {
                checkboxItem.append(`<div class="column-info">‚ö†Ô∏è ${info.null_count} missing values</div>`);
            }
            
            if (info.sample_values.length > 0) {
                const sampleText = info.sample_values.slice(0, 2).join(', ');
                checkboxItem.append(`<div class="column-info">üìä Sample: ${sampleText}</div>`);
            }
            
            $('#featureCols').append(checkboxItem);
        });
        
        // Show info about hidden date columns
        const dateColumns = columns.filter(col => columnInfo[col].is_date);
        if (dateColumns.length > 0) {
            const hiddenInfo = $(`
                <div class="info" style="margin-top: 15px;">
                    <strong>üìÖ Date columns hidden:</strong> ${dateColumns.join(', ')} 
                    <br><small>Date columns are automatically excluded from prediction models.</small>
                </div>
            `);
            $('#featureCols').after(hiddenInfo);
        }
    }
    
    function updateFeatureCheckboxes(selectedTarget) {
        // Hide the target column from feature selection
        $('input[name="features"]').each(function() {
            const featureName = $(this).val();
            const checkboxItem = $(this).closest('.checkbox-item');
            
            if (featureName === selectedTarget) {
                checkboxItem.hide();
                $(this).prop('checked', false);
            } else {
                checkboxItem.show();
            }
        });
    }
    
    function updateTrainButton() {
        const target = $('#targetCol').val();
        const features = $('input[name="features"]:checked').length;
        
        if (target && features > 0) {
            $('#trainBtn').prop('disabled', false);
        } else {
            $('#trainBtn').prop('disabled', true);
        }
    }
    
    function trainModel() {
        const target = $('#targetCol').val();
        const features = [];
        $('input[name="features"]:checked').each(function() {
            features.push($(this).val());
        });
        
        if (!target || features.length === 0) {
            showError('#trainError', 'Please select both target and feature columns.');
            return;
        }
        
        hideMessages();
        showLoading();

            $.ajax({
            url: '/train',
            type: 'POST',
            data: {
                target: target,
                'features[]': features
            },
            success: function(response) {
                hideLoading();
                if (response.error) {
                    showError('#trainError', response.error);
                } else {
                    const scoreInfo = `üìä R¬≤ Score: ${response.r2_score}`;
                    const sampleInfo = `üìà Trained on ${response.sample_count} samples with ${response.feature_count} features`;
                    showInfo('#trainInfo', `${response.message}<br>ü§ñ Using Linear Regression<br>${scoreInfo}<br>${sampleInfo}`);
                    generatePredictionForm(features);
                    $('#step3').removeClass('hidden').addClass('active');
                    $('#step2').removeClass('active');
                }
            },
            error: function(xhr) {
                hideLoading();
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Training failed';
                showError('#trainError', error);
            }
        });
    }
    
    function generatePredictionForm(features) {
        const form = $('#predictionForm');
        form.empty();
        
        features.forEach(function(feature) {
            const info = columnInfo[feature];
            const formGroup = $(`
                <div class="form-group">
                    <label for="input_${feature}">${feature}</label>
                </div>
            `);
            
            if (!info.is_numerical) {
                // Create dropdown for categorical features with ALL unique values
                const select = $(`<select id="input_${feature}" name="${feature}" required></select>`);
                select.append('<option value="">Select value...</option>');
                
                // Get ALL unique values from the data, not just sample values
                if (info.unique_values && info.unique_values.length > 0) {
                    info.unique_values.forEach(function(value) {
                        select.append(`<option value="${value}">${value}</option>`);
                    });
                } else {
                    // Fallback to sample values if unique_values not available
                    const uniqueValues = [...new Set(info.sample_values)];
                    uniqueValues.forEach(function(value) {
                        select.append(`<option value="${value}">${value}</option>`);
                    });
                }
                
                formGroup.append(select);
                formGroup.append(`<div class="column-info">üìù Categorical - Select from ${info.unique_count} unique values</div>`);
            } else {
                // Create number input for numerical features
                const input = $(`<input type="number" id="input_${feature}" name="${feature}" step="any" required>`);
                formGroup.append(input);
                formGroup.append(`<div class="column-info">üî¢ Numerical - Enter a number</div>`);
            }
            
            if (info.null_count > 0) {
                formGroup.append(`<div class="column-info">‚ö†Ô∏è This column has ${info.null_count} missing values</div>`);
            }
            
            form.append(formGroup);
        });
    }
    
    function makePrediction() {
        const inputData = {};
        let isValid = true;
        
        $('#predictionForm input, #predictionForm select').each(function() {
            const name = $(this).attr('name');
            const value = $(this).val();
            
            if (!value) {
                isValid = false;
                $(this).css('border-color', '#ff416c');
            } else {
                $(this).css('border-color', '#ddd');
                inputData[name] = value;
            }
        });
        
        if (!isValid) {
            showError('#predictError', 'Please fill in all required fields.');
            return;
        }
        
        hideMessages();
        showLoading();

            $.ajax({
            url: '/predict',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(inputData),
            success: function(response) {
                hideLoading();
                if (response.error) {
                    showError('#predictError', response.error);
                } else {
                    $('#result').html(`
                        <div style="font-size: 1.5em; margin-bottom: 10px;">üéØ Prediction Result</div>
                        <div style="font-size: 2em; font-weight: bold;">${response.prediction}</div>
                        <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                            ü§ñ Linear Regression Model<br>
                            ${response.message}
                        </div>
                    `).removeClass('hidden');
                }
            },
            error: function(xhr) {
                hideLoading();
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Prediction failed';
                showError('#predictError', error);
            }
        });
    }
    </script>
</body>
</html>
